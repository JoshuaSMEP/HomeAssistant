blueprint:
  name: Room Temperature Control (with Outdoor Sensor)
  description: |
    Control a smart plug switch based on indoor temperature sensor readings.
    - Turns switch ON when indoor temperature > High Threshold (only if outdoor ≤ Low Threshold or no outdoor sensor).
    - Turns switch OFF when indoor temperature < Low Threshold.
  domain: automation
  input:
    temperature_sensor:
      name: Indoor Temperature Sensor
      description: The indoor temperature sensor entity (e.g., sensor.living_room_temp).
      selector:
        entity:
          domain: sensor
          device_class: temperature
    switch_entity:
      name: Switch Entity
      description: The smart plug switch to control (e.g., switch.bedroom_fan).
      selector:
        entity:
          domain: switch
    high_temperature:
      name: High Temperature Threshold
      description: Indoor temperature above which the switch attempts to turn ON (e.g., 75.5).
      default: 75.5
      selector:
        number:
          min: 0
          max: 100
          step: 0.1
          unit_of_measurement: "°F"
    low_temperature:
      name: Low Temperature Threshold
      description: Indoor temperature below which the switch turns OFF; also used to check if outdoor ≤ this value before turning ON (e.g., 74).
      default: 74
      selector:
        number:
          min: 0
          max: 100
          step: 0.1
          unit_of_measurement: "°F"
    outdoor_temperature_sensor:
      name: Outdoor Temperature Sensor
      description: Optional outdoor temperature sensor entity (e.g., sensor.outdoor_temp). If not provided or unavailable, the ON condition is always allowed.
      default: {}
      selector:
        entity:
          domain: sensor
          device_class: temperature

trigger:
  - platform: numeric_state
    entity_id: !input temperature_sensor
    above: !input high_temperature
    id: turn_on
  - platform: numeric_state
    entity_id: !input temperature_sensor
    below: !input low_temperature
    id: turn_off

condition: []

action:
  - choose:
      # Handle turn_on trigger
      - conditions:
          - condition: trigger
            id: turn_on
        sequence:
          # Condition: Allow ON only if no outdoor sensor or outdoor <= low_threshold
          - condition: template
            value_template: >-
              {% set outdoor = !input outdoor_temperature_sensor %}
              {% if outdoor == none or outdoor == '' or is_state(outdoor, 'unavailable') %}
                true
              {% else %}
                (states(outdoor) | float(-999) <= !input low_temperature)
              {% endif %}
          - service: switch.turn_on
            target:
              entity_id: !input switch_entity
      # Handle turn_off trigger
      - conditions:
          - condition: trigger
            id: turn_off
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input switch_entity
    default: []

mode: single
